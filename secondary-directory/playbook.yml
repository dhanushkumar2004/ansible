---
- name: Change wallpaper on Ubuntu systems
  hosts: ubuntu_nodes
  become: yes
  vars:
    wallpaper_source: "files/custom_wallpaper.jpg"
    wallpaper_dest: "/usr/share/backgrounds/custom_wallpaper.jpg"

  tasks:
    - name: Copy wallpaper to target machine
      ansible.builtin.copy:
        src: "{{ wallpaper_source }}"
        dest: "{{ wallpaper_dest }}"
        mode: '0644'

    - name: Get all users with home directories
      ansible.builtin.command: getent passwd
      register: passwd_entries

    - name: Apply wallpaper for all users (GNOME)
      ansible.builtin.shell: |
        export DISPLAY=:0
        export XDG_RUNTIME_DIR=/run/user/$(id -u {{ item.split(':')[0] }})
        gsettings set org.gnome.desktop.background picture-uri 'file://{{ wallpaper_dest }}'
        gsettings set org.gnome.desktop.background picture-uri-dark 'file://{{ wallpaper_dest }}'
      become_user: "{{ item.split(':')[0] }}"
      loop: "{{ passwd_entries.stdout_lines }}"
      when: 
        - item.split(':')[5] is search("/home")   # Only users with /home directories

