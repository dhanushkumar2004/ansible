---
- name: Check AppArmor Configuration and Enforcement
  hosts: all
  become: true
  gather_facts: false

  tasks:

    ####################################################################
    # 1️⃣ Ensure AppArmor is installed
    ####################################################################
    - name: Check if AppArmor package is installed
      command: dpkg -l | grep -w apparmor
      register: apparmor_pkg
      ignore_errors: true
      changed_when: false

    - name: Report AppArmor installation status
      debug:
        msg: >
          {% if apparmor_pkg.rc == 0 %}
            ✅ AppArmor installation policy satisfied (package found)
          {% else %}
            ❌ AppArmor installation policy NOT satisfied (package missing)
          {% endif %}

    ####################################################################
    # 2️⃣ Ensure AppArmor is enabled in the bootloader (kernel runtime check)
    ####################################################################
    - name: Check if AppArmor is enabled in kernel
      command: cat /sys/module/apparmor/parameters/enabled
      register: kernel_enabled
      ignore_errors: true
      changed_when: false

    - name: Report AppArmor kernel enablement status
      debug:
        msg: >
          {% if kernel_enabled.stdout.strip() == 'Y' %}
            ✅ AppArmor is enabled in the kernel (policy satisfied)
          {% else %}
            ❌ AppArmor is NOT enabled in the kernel (policy NOT satisfied)
          {% endif %}

    ####################################################################
    # 3️⃣ Ensure all AppArmor profiles are in enforce or complain mode
    ####################################################################
    - name: Check AppArmor profile status
      command: aa-status
      register: aa_status
      ignore_errors: true
      changed_when: false

    - name: Report profiles enforce/complain mode
      debug:
        msg: >
          {% if 'profiles are loaded' in aa_status.stdout and 'profiles are disabled' not in aa_status.stdout %}
            ✅ All AppArmor profiles are in enforce or complain mode (policy satisfied)
          {% elif '0 profiles are disabled' in aa_status.stdout %}
            ✅ All AppArmor profiles are in enforce or complain mode (policy satisfied)
          {% else %}
            ❌ Some AppArmor profiles are disabled (policy NOT satisfied)
          {% endif %}

    ####################################################################
    # 4️⃣ Ensure all AppArmor profiles are enforcing
    ####################################################################
    - name: Extract enforce and total profile counts
      set_fact:
        enforce_total: "{{ (aa_status.stdout | regex_search('([0-9]+) profiles are in enforce mode', '\\1')) | default('0') | int }}"
        total_profiles: "{{ (aa_status.stdout | regex_search('([0-9]+) profiles are loaded', '\\1')) | default('0') | int }}"

    - name: Report enforcement status
      debug:
        msg: >
          {% if enforce_total == total_profiles and total_profiles > 0 %}
            ✅ All AppArmor profiles are enforcing (policy satisfied)
          {% else %}
            ❌ Not all AppArmor profiles are enforcing (policy NOT satisfied)
          {% endif %}
