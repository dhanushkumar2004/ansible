---
- name: Check AppArmor Compliance (Simple JSON Summary)
  hosts: all
  become: true
  gather_facts: true

  vars:
    report_dir: "{{ ansible_env.HOME }}/CIS-linux-hardening"
    timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
    report_file: "{{ report_dir }}/apparmor_status_{{ timestamp }}.json"

  tasks:

    #####################################################################
    # 1️⃣ Ensure AppArmor is installed
    #####################################################################
    - name: Check if AppArmor package is installed
      command: dpkg -s apparmor
      register: apparmor_pkg
      ignore_errors: true
      changed_when: false

    - set_fact:
        apparmor_installed: "{{ apparmor_pkg.rc == 0 }}"

    #####################################################################
    # 2️⃣ Ensure AppArmor is enabled in the bootloader (kernel)
    #####################################################################
    - name: Check if AppArmor is enabled in the kernel
      command: cat /sys/module/apparmor/parameters/enabled
      register: apparmor_kernel
      ignore_errors: true
      changed_when: false

    - set_fact:
        apparmor_enabled: "{{ apparmor_kernel.stdout.strip() == 'Y' }}"

    #####################################################################
    # 3️⃣ Ensure all AppArmor Profiles are in enforce or complain mode
    #####################################################################
    - name: Check AppArmor status output
      command: aa-status
      register: aa_status
      ignore_errors: true
      changed_when: false

    - set_fact:
        apparmor_profiles_ok: "{{ ('profiles are loaded' in aa_status.stdout) and ('profiles are disabled' not in aa_status.stdout) }}"

    #####################################################################
    # 4️⃣ Ensure all AppArmor Profiles are enforcing
    #####################################################################
    - set_fact:
        apparmor_all_enforcing: "{{ 'profiles are in enforce mode' in aa_status.stdout and 'profiles are in complain mode' not in aa_status.stdout }}"

    #####################################################################
    # 5️⃣ Prepare compliance result summary
    #####################################################################
    - set_fact:
        apparmor_summary:
          "Ensure AppArmor is installed": "{{ 'Yes' if apparmor_installed else 'No (Action Required)' }}"
          "Ensure AppArmor is enabled in the bootloader configuration": "{{ 'Yes' if apparmor_enabled else 'No (Action Required)' }}"
          "Ensure all AppArmor Profiles are in enforce or complain mode": "{{ 'Yes' if apparmor_profiles_ok else 'No (Action Required)' }}"
          "Ensure all AppArmor Profiles are enforcing": "{{ 'Yes' if apparmor_all_enforcing else 'No (Action Required)' }}"

    #####################################################################
    # 6️⃣ Ensure destination folder exists on remote host
    #####################################################################
    - name: Create directory for CIS Linux Hardening reports
      file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

    #####################################################################
    # 7️⃣ Save JSON report to remote host
    #####################################################################
    - name: Save AppArmor compliance report as JSON
      copy:
        dest: "{{ report_file }}"
        content: "{{ apparmor_summary | to_nice_json }}"
        mode: '0644'

    #####################################################################
    # 8️⃣ Display summary in console
    #####################################################################
    - name: Display AppArmor Compliance Summary
      debug:
        msg: |
          ------------------------------------------------------------
          AppArmor Compliance Report
          ------------------------------------------------------------
          Ensure AppArmor is installed:                     {{ apparmor_summary['Ensure AppArmor is installed'] }}
          Ensure AppArmor is enabled in the bootloader:     {{ apparmor_summary['Ensure AppArmor is enabled in the bootloader configuration'] }}
          Ensure all Profiles are in enforce/complain mode: {{ apparmor_summary['Ensure all AppArmor Profiles are in enforce or complain mode'] }}
          Ensure all Profiles are enforcing:                {{ apparmor_summary['Ensure all AppArmor Profiles are enforcing'] }}
          ------------------------------------------------------------
          Report saved to: {{ report_file }}




