---
- name: Verify AppArmor Configuration and Enforcement (Read-Only Check)
  hosts: all
  become: true
  gather_facts: false

  tasks:

    ####################################################################
    # 1ï¸âƒ£ Ensure AppArmor is installed
    ####################################################################
    - name: Check if AppArmor is installed
      command: dpkg -l apparmor
      register: apparmor_pkg
      ignore_errors: true
      changed_when: false

    - name: Report AppArmor installation status
      set_fact:
        apparmor_installed: "{{ 'ii' in apparmor_pkg.stdout }}"
      changed_when: false

    ####################################################################
    # 2ï¸âƒ£ Ensure AppArmor is enabled in kernel (boot/runtime check)
    ####################################################################
    - name: Check if AppArmor is enabled in kernel
      command: cat /sys/module/apparmor/parameters/enabled
      register: kernel_enabled
      ignore_errors: true
      changed_when: false

    - name: Report AppArmor kernel enablement status
      set_fact:
        apparmor_enabled_kernel: "{{ kernel_enabled.stdout.strip() == 'Y' }}"
      changed_when: false

    ####################################################################
    # 3ï¸âƒ£ Gather AppArmor profile and process stats
    ####################################################################
    - name: Run aa-status to gather details
      command: aa-status
      register: aa_status
      ignore_errors: true
      changed_when: false

    - name: Extract all key metrics from aa-status output
      set_fact:
        total_profiles: "{{ aa_status.stdout | regex_search('([0-9]+) profiles are loaded', '\\1') | default('0') | int }}"
        enforce_profiles: "{{ aa_status.stdout | regex_search('([0-9]+) profiles are in enforce mode', '\\1') | default('0') | int }}"
        complain_profiles: "{{ aa_status.stdout | regex_search('([0-9]+) profiles are in complain mode', '\\1') | default('0') | int }}"
        disabled_profiles: "{{ aa_status.stdout | regex_search('([0-9]+) profiles are in kill mode', '\\1') | default('0') | int }}"
        total_processes: "{{ aa_status.stdout | regex_search('([0-9]+) processes have profiles defined', '\\1') | default('0') | int }}"
        enforce_processes: "{{ aa_status.stdout | regex_search('([0-9]+) processes are in enforce mode', '\\1') | default('0') | int }}"
        complain_processes: "{{ aa_status.stdout | regex_search('([0-9]+) processes are in complain mode', '\\1') | default('0') | int }}"
      changed_when: false

    ####################################################################
    # 4ï¸âƒ£ Report AppArmor profile mode satisfaction
    ####################################################################
    - name: Report enforce/complain mode satisfaction
      set_fact:
        profiles_enforce_complain_ok: "{{ total_profiles | int > 0 and disabled_profiles | int == 0 }}"
      changed_when: false

    ####################################################################
    # 5ï¸âƒ£ Ensure all profiles are enforcing
    ####################################################################
    - name: Report enforcing satisfaction
      set_fact:
        profiles_all_enforcing: "{{ enforce_profiles | int == total_profiles | int and total_profiles | int > 0 }}"
      changed_when: false

    ####################################################################
    # 6ï¸âƒ£ Summary Report
    ####################################################################
    - name: Display AppArmor Configuration Summary
      debug:
        msg: |
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ”’ **AppArmor Security Status Summary**
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ“¦ Installed: {{ 'âœ… Yes' if apparmor_installed else 'âŒ No' }}
          âš™ï¸ Kernel Enabled: {{ 'âœ… Yes' if apparmor_enabled_kernel else 'âŒ No' }}
          ğŸ§© All Profiles in Enforce/Complain: {{ 'âœ… Yes' if profiles_enforce_complain_ok else 'âŒ No' }}
          ğŸ” All Profiles Enforcing: {{ 'âœ… Yes' if profiles_all_enforcing else 'âŒ No' }}
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ“Š Profile Statistics:
              â€¢ Total Profiles: {{ total_profiles }}
              â€¢ Enforce Mode:   {{ enforce_profiles }}
              â€¢ Complain Mode:  {{ complain_profiles }}
              â€¢ Disabled:       {{ disabled_profiles }}
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          âš™ï¸ Process Statistics:
              â€¢ Processes w/ Profiles: {{ total_processes }}
              â€¢ Enforce Mode:          {{ enforce_processes }}
              â€¢ Complain Mode:         {{ complain_processes }}
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

